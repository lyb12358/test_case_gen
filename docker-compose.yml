version: '3.8'

services:
  tsp-backend:
    build:
      context: .
      dockerfile: Dockerfile.backend
    ports:
      - "8475:8000"
    environment:
      # Docker 环境数据库配置（覆盖 .env）
      - HOST=host.docker.internal:8474
      - USER=tsp
      - PASSWORD=2222
      - DATABASE=testcase_gen
    volumes:
      - ./output:/app/output
      - ./logs:/app/logs
    restart: unless-stopped

  tsp-frontend:
    build:
      context: ./web
      dockerfile: Dockerfile
      args:
        # 构建时传递环境变量
        - NODE_ENV=production
    expose:
      - "5173"
    environment:
      - NODE_ENV=production
    restart: unless-stopped

  tsp-nginx:
    image: docker.1ms.run/library/nginx:latest
    ports:
      - "8476:80"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf
    depends_on:
      - tsp-frontend
      - tsp-backend
    restart: unless-stopped